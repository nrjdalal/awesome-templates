name: update-templates

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 */8 * * *'

concurrency: ${{ github.workflow }}-${{ github.ref }}

permissions:
  contents: write

jobs:
  update-templates:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Restore Bun Cache
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Execute and Commit Scripts
        run: |
          set -e
          DATE=$(date -u +"%b %d %H:%M UTC %y")
          EMOJIS=("ðŸ”´" "ðŸŸ " "ðŸŸ¡" "ðŸŸ¢" "ðŸ”µ" "ðŸŸ£" "ðŸŸ¤")
          DAY_OF_WEEK=$(date -u +"%w")
          EMOJI=${EMOJIS[$DAY_OF_WEEK]}

          rm -f ./.github/failed.txt

          for script in ./.github/.scripts/*.sh; do
            echo -e "\033[33m--------------------------------------------------\033[0m"
            echo -e "\033[33m$script\033[0m"
            echo -e "\033[33m--------------------------------------------------\033[0m"
            
            SCRIPT_NAME=$(basename "$script" .sh)
            BRANCH_NAME="template-$SCRIPT_NAME"
            TEMP_DIR="$BRANCH_NAME"
            
            git checkout -b "$BRANCH_NAME"
            
            if TEMP_DIR="$TEMP_DIR" bash "$script"; then
              rsync -a --delete --exclude=".git" "$TEMP_DIR/" "./$SCRIPT_NAME/"
              rm -rf "$TEMP_DIR"
              git checkout main
              git merge "$BRANCH_NAME"
              git branch -d "$BRANCH_NAME"
              echo "Committing changes for $script"
              git add .
              git commit -m "$EMOJI $DATE" || true
            else
              echo -e "\033[31mFailed $script\033[0m"
              git reset --hard
              git clean -fdx
              git checkout main
              git branch -D "$BRANCH_NAME"
              echo "$script" >> ./.github/failed.txt
              git add ./.github/failed.txt
              git commit -m "$EMOJI $DATE"
            fi
          done

          sed -i "3s/.*/> Last updated: $EMOJI $DATE/" ./.github/README.md
          git add ./.github/README.md
          git commit -m "$EMOJI $DATE"

      - name: Push Changes
        run: git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
